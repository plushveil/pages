name: CD

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [ latest ]

jobs:
  preview:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout repository
      if: github.event.action != 'closed'
      uses: actions/checkout@v4

    - id: build
      if: github.event.action != 'closed'
      uses: plushveil/pages@latest
      with:
        folder: 'website'
      env:
        HOST: plushveil.github.io
        PORT: 443
        PATHNAME: /pages/preview/${{ github.event.number }}/
  
    - name: Checkout GitHub Pages Branch
      uses: actions/checkout@v4
      with:
        ref: gh-pages
        path: gh-pages

    - name: Deploy to GitHub Pages
      run: |
        cd gh-pages
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        rm -rf preview/${{ github.event.number }}
        mkdir -p preview/${{ github.event.number }}
        if [ "${{ github.event.action }}" != "closed" ]; then cp -r ${{steps.build.outputs.folder}}/* preview/${{ github.event.number }}; fi
        git add .
        git commit -m "${{ github.actor }}: preview pull request #${{ github.event.number }}" || exit 0
        git push

    - name: Comment on Pull Request
      if: github.event.action == 'opened'
      uses: actions/github-script@v3
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'Preview: https://plushveil.github.io/pages/preview/${{ github.event.number }}/'
          })
